<!DOCTYPE html>
<html>
<head>
    <title>Test Student Import Structure</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .structure-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .structure-table th, .structure-table td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        .structure-table th { background-color: #f5f5f5; }
        .required { color: red; font-weight: bold; }
        .optional { color: green; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>üéì C·∫•u Tr√∫c Import Sinh Vi√™n - VMU Quiz System</h1>
    
    <div class="section">
        <h2>üìã C·∫•u tr√∫c Excel cho Import Sinh Vi√™n</h2>
        <table class="structure-table">
            <thead>
                <tr>
                    <th>T√™n c·ªôt</th>
                    <th>T√™n c·ªôt thay th·∫ø</th>
                    <th>M√¥ t·∫£</th>
                    <th>V√≠ d·ª•</th>
                    <th>B·∫Øt bu·ªôc</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><code>studentCode</code></td>
                    <td><code>username</code></td>
                    <td>M√£ sinh vi√™n (duy nh·∫•t)</td>
                    <td>SV001, 2024001</td>
                    <td class="required">C√≥</td>
                </tr>
                <tr>
                    <td><code>fullName</code></td>
                    <td><code>H·ªç t√™n</code></td>
                    <td>H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß</td>
                    <td>Nguy·ªÖn VƒÉn An</td>
                    <td class="required">C√≥</td>
                </tr>
                <tr>
                    <td><code>email</code></td>
                    <td><code>Email</code></td>
                    <td>Email sinh vi√™n (duy nh·∫•t)</td>
                    <td>an.nguyen@vmu.edu.vn</td>
                    <td class="required">C√≥</td>
                </tr>
                <tr>
                    <td><code>phoneNumber</code></td>
                    <td><code>S·ªë ƒëi·ªán tho·∫°i</code></td>
                    <td>S·ªë ƒëi·ªán tho·∫°i</td>
                    <td>0123456789</td>
                    <td class="required">C√≥</td>
                </tr>
                <tr>
                    <td><code>classId</code></td>
                    <td><code>M√£ l·ªõp</code></td>
                    <td>ID c·ªßa l·ªõp h·ªçc</td>
                    <td>1, 2, 3</td>
                    <td class="required">C√≥</td>
                </tr>
                <tr>
                    <td><code>username</code></td>
                    <td><code>studentCode</code></td>
                    <td>T√™n ƒëƒÉng nh·∫≠p</td>
                    <td>SV001</td>
                    <td class="required">C√≥</td>
                </tr>
                <tr>
                    <td><code>password</code></td>
                    <td>-</td>
                    <td>M·∫≠t kh·∫©u ƒëƒÉng nh·∫≠p</td>
                    <td>123456</td>
                    <td class="optional">Kh√¥ng (m·∫∑c ƒë·ªãnh: 123456)</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>üîß C√¥ng c·ª• test</h2>
        
        <h3>1. T·∫°o file Excel m·∫´u</h3>
        <button onclick="createSampleFile()">T·∫°o file Excel m·∫´u</button>
        
        <h3>2. Test ƒë·ªçc file Excel</h3>
        <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="readStudentFile(event)">
        
        <h3>3. K·∫øt qu·∫£ ph√¢n t√≠ch</h3>
        <pre id="result"></pre>
    </div>

    <div class="section">
        <h2>üìù Backend Logic</h2>
        <p><strong>Endpoint:</strong> <code>POST /api/students/import-excel</code></p>
        <p><strong>Method:</strong> Multer file upload</p>
        <p><strong>Process:</strong></p>
        <ol>
            <li>Upload file Excel qua multer</li>
            <li>ƒê·ªçc file b·∫±ng <code>xlsx.readFile()</code></li>
            <li>Chuy·ªÉn sheet ƒë·∫ßu ti√™n th√†nh JSON: <code>xlsx.utils.sheet_to_json()</code></li>
            <li>L·∫∑p qua t·ª´ng d√≤ng d·ªØ li·ªáu</li>
            <li>Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc</li>
            <li>Ki·ªÉm tra tr√πng l·∫∑p email/username</li>
            <li>T·∫°o User record</li>
            <li>T·∫°o Student record</li>
            <li>Tr·∫£ v·ªÅ danh s√°ch sinh vi√™n ƒë√£ import</li>
        </ol>
    </div>

    <script>
        function createSampleFile() {
            // T·∫°o d·ªØ li·ªáu m·∫´u cho import sinh vi√™n
            const sampleData = [
                {
                    studentCode: "SV001",
                    fullName: "Nguy·ªÖn VƒÉn An",
                    email: "an.nguyen@vmu.edu.vn",
                    phoneNumber: "0123456789",
                    classId: "1",
                    username: "SV001",
                    password: "123456"
                },
                {
                    studentCode: "SV002", 
                    fullName: "Tr·∫ßn Th·ªã B√¨nh",
                    email: "binh.tran@vmu.edu.vn",
                    phoneNumber: "0987654321",
                    classId: "2", 
                    username: "SV002",
                    password: "123456"
                },
                {
                    studentCode: "SV003",
                    fullName: "L√™ VƒÉn C∆∞·ªùng",
                    email: "cuong.le@vmu.edu.vn", 
                    phoneNumber: "0345678901",
                    classId: "1",
                    username: "SV003", 
                    password: "123456"
                },
                {
                    studentCode: "SV004",
                    "H·ªç t√™n": "Ph·∫°m Th·ªã Dung",
                    "Email": "dung.pham@vmu.edu.vn",
                    "S·ªë ƒëi·ªán tho·∫°i": "0567890123",
                    "M√£ l·ªõp": "3",
                    username: "SV004",
                    password: "123456"
                }
            ];

            // T·∫°o workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(sampleData);
            
            XLSX.utils.book_append_sheet(wb, ws, "Students");
            
            // Download file
            XLSX.writeFile(wb, "student-import-sample.xlsx");
            
            document.getElementById('result').textContent = "‚úÖ ƒê√£ t·∫°o file student-import-sample.xlsx v·ªõi 4 sinh vi√™n m·∫´u";
        }

        function readStudentFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    console.log('Raw Excel data:', jsonData);
                    
                    // X·ª≠ l√Ω gi·ªëng nh∆∞ trong backend
                    const processedStudents = [];
                    const errors = [];
                    
                    jsonData.forEach((row, index) => {
                        const rowNum = index + 1;
                        
                        // ƒê·ªçc d·ªØ li·ªáu t·ª´ file (gi·ªëng backend logic)
                        const studentCode = row['studentCode'] || row['username'];
                        const fullName = row['fullName'] || row['H·ªç t√™n'];
                        const email = row['email'] || row['Email'];
                        const phoneNumber = row['phoneNumber'] || row['S·ªë ƒëi·ªán tho·∫°i'];
                        const classId = row['classId'] || row['M√£ l·ªõp'];
                        const username = row['username'] || studentCode;
                        const password = row['password'] || '123456';
                        
                        // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc
                        const requiredFields = {
                            studentCode,
                            fullName,
                            email,
                            phoneNumber,
                            classId,
                            username
                        };
                        
                        const missingFields = Object.entries(requiredFields)
                            .filter(([key, value]) => !value || value.toString().trim() === '')
                            .map(([key]) => key);
                        
                        if (missingFields.length > 0) {
                            errors.push(`D√≤ng ${rowNum}: Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc: ${missingFields.join(', ')}`);
                            return;
                        }
                        
                        // Ki·ªÉm tra ƒë·ªãnh d·∫°ng email
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        if (!emailRegex.test(email)) {
                            errors.push(`D√≤ng ${rowNum}: Email kh√¥ng h·ª£p l·ªá: ${email}`);
                            return;
                        }
                        
                        // Ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i
                        const phoneRegex = /^\d{10,11}$/;
                        if (!phoneRegex.test(phoneNumber.replace(/\s/g, ''))) {
                            errors.push(`D√≤ng ${rowNum}: S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá: ${phoneNumber}`);
                            return;
                        }
                        
                        processedStudents.push({
                            rowNum,
                            studentCode: studentCode.toString().trim(),
                            fullName: fullName.toString().trim(),
                            email: email.toString().trim(),
                            phoneNumber: phoneNumber.toString().trim(),
                            classId: classId.toString().trim(),
                            username: username.toString().trim(),
                            password: password.toString().trim()
                        });
                    });
                    
                    // Ki·ªÉm tra tr√πng l·∫∑p trong file
                    const duplicateEmails = processedStudents
                        .map(s => s.email)
                        .filter((email, index, arr) => arr.indexOf(email) !== index);
                    
                    const duplicateUsernames = processedStudents
                        .map(s => s.username)
                        .filter((username, index, arr) => arr.indexOf(username) !== index);
                    
                    if (duplicateEmails.length > 0) {
                        errors.push(`Email tr√πng l·∫∑p trong file: ${[...new Set(duplicateEmails)].join(', ')}`);
                    }
                    
                    if (duplicateUsernames.length > 0) {
                        errors.push(`Username tr√πng l·∫∑p trong file: ${[...new Set(duplicateUsernames)].join(', ')}`);
                    }
                    
                    const result = {
                        summary: {
                            totalRows: jsonData.length,
                            validStudents: processedStudents.length,
                            errors: errors.length
                        },
                        rawData: jsonData,
                        processedStudents: processedStudents,
                        errors: errors,
                        backendLogic: {
                            note: "Backend s·∫Ω th√™m ki·ªÉm tra tr√πng l·∫∑p v·ªõi database",
                            nextSteps: [
                                "Ki·ªÉm tra email/username t·ªìn t·∫°i trong DB",
                                "T·∫°o User record v·ªõi role='STUDENT'", 
                                "T·∫°o Student record v·ªõi user_id",
                                "Tr·∫£ v·ªÅ danh s√°ch ƒë√£ import th√†nh c√¥ng"
                            ]
                        }
                    };
                    
                    document.getElementById('result').textContent = JSON.stringify(result, null, 2);
                    
                } catch (error) {
                    document.getElementById('result').textContent = `‚ùå L·ªói ƒë·ªçc file: ${error.message}`;
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
